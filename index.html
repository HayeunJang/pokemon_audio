<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pokémon Name</title>

  <!-- jsPsych -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css">
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.0.0"></script>

  <style>
    body { margin:0; padding:20px; font-family: Arial, sans-serif; }
    #jspsych-target { max-width: 900px; margin: 0 auto; }
    .row { display:flex; gap:16px; align-items:flex-start; }
    .col { flex:1; }
    .guide {
      max-width: 370px; border:1px solid #ddd; border-radius:8px; padding:12px; background:#fafafa;
      font-size: 13px; line-height: 1.35;
    }
    .guide img { width:100%; height:auto; display:block; border-radius:6px; }
    .prompt { margin:8px 0 12px; }
    .audio-wrap { margin:8px 0 12px; }
    .wait-note { font-size: 13px; color:#666; margin-top:4px; }
    .disabled-btn { opacity: .5; pointer-events: none; }
  </style>
</head>
<body>
<div id="jspsych-target"></div>

<script>
  /******************************************************
   * Pokémon Name 2AFC (Audio pair in a single file)
   * - AB/BA 파일 중 랜덤 선택
   * - 타입 가이드 이미지 고정
   * - Google Sheets 업로드
   ******************************************************/

  /* ===== CONFIG ===== */
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzBKKcE4iZn7-D7Nvv2KHdKBmGccB0XlfQDT0NfA9EfVpOLltmNVaidWKaMeM8-qbXjRA/exec'; 
  const TYPE_GUIDE_IMG = 'img/type_guide.png';  

  /* ===== TEXTS ===== */
  const TEXTS = {
    welcomeTitle: '포켓몬 이름 선택',
    welcomeBody: `
    포켓몬 타입에는 여러가지가 있습니다.<br>
    그 중 Flying, Dark, Fairy는 일반적으로 Normal과 비교해 아래와 같은 특징을 가지고 있습니다.<br>
    - Flying 타입: 하늘을 난다 fly in the sky<br>
    - Dark 타입: 악하다 villainous, evil<br>
    - Fairy 타입: 귀엽다 cute<br><br>
    오른쪽 그림은 <em>AI가 생성한 참고용 예시</em>이며 실제 포켓몬이 아닙니다.<br><br>
    각 trial에서 <strong>하나의 오디오</strong>에 <strong>두 개의 이름</strong>이 순차적으로 들립니다.<br>
    오디오를 끝까지 들은 뒤, 제시된 <strong>타겟 타입</strong>에 더 어울리는 이름을 선택하세요.
    `,
    startBtn: '시작',
    listenFirst: '오디오를 끝까지 들어야 버튼이 활성화됩니다.',
    endTitle: '참여해 주셔서 감사합니다!',
    endBody: '데이터 업로드를 시도했습니다. 만약 아래에 CSV 다운로드 버튼이 나타나면, 파일을 다운로드하여 실험자에게 보내주세요.',
    finishBtn: '종료'
  };

  /* ===== BASE TRIALS =====
   * 각 trial은 파일 prefix만 지정하고, 실제 파일은 *_AB.wav / *_BA.wav 중
   * 하나를 무작위로 선택해 STIMULI로 생성합니다.
   */
  const BASE_TRIALS = [
    { id: "01", prefix: "01_", nameA: "Silshin",  nameB: "Tiltin",   target_type: "Flying"  },
    // { id: "02", prefix: "02_", nameA: "Salshim",  nameB: "Taltim",  target_type: "Flying"   },
    // { id: "03", prefix: "03_", nameA: "Sulshur",   nameB: "Tulkur",  target_type: "Flying" },
   //  { id: "04", prefix: "04_", nameA: "Surshum",    nameB: "Turkum",   target_type: "Flying" },
    // { id: "05", prefix: "05_", nameA: "Shieshen",  nameB: "Kieten",   target_type: "Flying"  },
    // { id: "06", prefix: "06_", nameA: "Shilsun",  nameB: "Kiltun",  target_type: "Flying"   },
    // { id: "07", prefix: "07_", nameA: "Shalshick",   nameB: "Kaltick",  target_type: "Flying" },
    // { id: "08", prefix: "08_", nameA: "Shelshim",    nameB: "Kelkim",   target_type: "Flying" },
    // { id: "09", prefix: "09_", nameA: "Bringlin",  nameB: "Prinklin",   target_type: "Dark"  },
    // { id: "10", prefix: "10_", nameA: "Branzlam",  nameB: "Pranslam",  target_type: "Dark"   },
    // { id: "11", prefix: "11_", nameA: "Drinzlin",   nameB: "Trinslin",  target_type: "Dark" },
    // { id: "12", prefix: "12_", nameA: "Dramblum",    nameB: "Tramplum",   target_type: "Dark" },
    // { id: "13", prefix: "13_", nameA: "Grimblin",  nameB: "Krimplin",   target_type: "Dark"  },
   //  { id: "14", prefix: "14_", nameA: "Grenzlin",  nameB: "Krenslin",  target_type: "Dark"   },
   //  { id: "15", prefix: "15_", nameA: "Zegdum",   nameB: "Sektum",  target_type: "Dark" },
    { id: "16", prefix: "16_", nameA: "Zumgul",    nameB: "Sumkul",   target_type: "Dark" },
    { id: "17", prefix: "17_", nameA: "Peepol",   nameB: "Teetol",  target_type: "Fairy" },
   //  { id: "18", prefix: "18_", nameA: "Polpen",    nameB: "Tolken",   target_type: "Fairy" },
   //  { id: "19", prefix: "19_", nameA: "Pafpil",  nameB: "Tastil",   target_type: "Fairy"  },
   //  { id: "20", prefix: "20_", nameA: "Pimpock",  nameB: "Tintock",  target_type: "Fairy"   },
   //  { id: "21", prefix: "21_", nameA: "Paapair",   nameB: "Kaakair",  target_type: "Fairy" },
   //  { id: "22", prefix: "22_", nameA: "Pupmir",    nameB: "Kukmir",   target_type: "Fairy" },
   //  { id: "23", prefix: "23_", nameA: "Pepmil",   nameB: "Kekmil",  target_type: "Fairy" },
   //  { id: "24", prefix: "24_", nameA: "Parpil",    nameB: "Karkil",   target_type: "Fairy" },
  ];

  function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  // AB / BA 중 무작위 선택하여 STIMULI 생성
  const STIMULI = BASE_TRIALS.map(t => {
    const chosen = pickRandom(["AB", "BA"]);
    const audioPath = `./audio/${t.prefix}${chosen}.wav`;
    const targetType = String(t.target_type);
    
    // stimulus HTML 미리 생성
    const stimulus_html = `
      <div class="row">
        <div class="col">
          <div class="prompt">어떤 이름이 <strong>${targetType}-type Pokémon</strong>에 더 어울리나요?</div>
          <div class="audio-wrap">
            <audio id="stimAudio" controls preload="auto">
              <source src="${audioPath}" type="audio/wav"/>
              브라우저가 오디오를 지원하지 않습니다.
            </audio>
            <div class="wait-note">${TEXTS.listenFirst}</div>
          </div>
        </div>
        <div class="guide">
          <img src="${TYPE_GUIDE_IMG}" alt="Type guide (Normal/Flying/Dark/Fairy)">
          <div>그림: 타입 가이드 (참고용, AI 생성)</div>
        </div>
      </div>
    `;
    
    return {
      id: t.id,
      audio_path: audioPath,
      nameA: String(t.nameA),
      nameB: String(t.nameB),
      target_type: targetType,
      chosen_version: chosen,   // 분석 시 사용
      stimulus_html: stimulus_html
    };
  });

  // 진단: 오디오 파일 접근 가능 여부 로그
  STIMULI.forEach(s => {
    fetch(s.audio_path, { method: 'HEAD' })
      .then(r => console.log(`[CHECK] ${s.audio_path} -> ${r.status}`))
      .catch(e => console.warn(`[CHECK] ${s.audio_path} fetch error`, e));
  });

  
  /* ===== INIT ===== */
  let jsPsych = initJsPsych({
    display_element: 'jspsych-target',
    on_finish: async () => {
      // 백업용 CSV 다운로드 버튼 먼저 생성
      const csv = jsPsych.data.get().csv();
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `pokemon_data_${new Date().getTime()}.csv`;
      a.textContent = 'CSV 다운로드 (백업용)';
      a.style.display = 'block';
      a.style.margin = '20px auto';
      a.style.textAlign = 'center';
      a.style.fontSize = '16px';
      a.style.color = '#0066cc';
      document.body.appendChild(a);
      
      // Google Sheets 업로드 시도 (백그라운드)
      uploadAllRowsToGoogle();
    }
  });

  

  /* ===== PRELOAD ===== */
  const preload = {
    type: jsPsychPreload,
    audio: STIMULI.map(s => s.audio_path),
    images: [TYPE_GUIDE_IMG],
  };

  /* ===== WELCOME ===== */
  const welcome = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <div class="row">
        <div class="col">
          <h2>${TEXTS.welcomeTitle}</h2>
          <p>${TEXTS.welcomeBody}</p>
        </div>
        <div class="guide">
          <img src="${TYPE_GUIDE_IMG}" alt="Type guide (Normal/Flying/Dark/Fairy)">
          <div>그림: 타입 가이드(참고용, AI 생성)</div>
        </div>
      </div>
    `,
    choices: [TEXTS.startBtn]
  };

  /* ===== 2AFC TRIAL ===== */
  let currentTrialStartTime = null;   // trial 시작 시각

  const twoAFC_trial = {
    type: jsPsychHtmlButtonResponse,
    stimulus: function() {
      const data = jsPsych.evaluateTimelineVariable('target_type');
      return jsPsych.timelineVariable('stimulus_html');
    },
    // 버튼 라벨: 오디오 순서 그대로 (첫 번째 이름, 두 번째 이름)
    choices: ['첫 번째 이름', '두 번째 이름'],
    response_allowed_while_playing: true, // 보이긴 하지만 on_load에서 잠금
    button_html: (choice, i) =>
      `<button class="jspsych-btn disabled-btn" data-btn-index="${i}" disabled>${choice}</button>`,
    on_load: () => {
      currentTrialStartTime = new Date().toISOString();

      // 버튼 잠금
      const btns = document.querySelectorAll('button.jspsych-btn');
      btns.forEach(b => { b.disabled = true; b.classList.add('disabled-btn'); });

      // 오디오 끝나면 버튼 해제
      const audio = document.getElementById('stimAudio');
      if (audio) {
        const enable = () => {
          btns.forEach(b => { b.disabled = false; b.classList.remove('disabled-btn'); });
        };
        audio.addEventListener('ended', enable, { once: true });
      }
    },
    on_finish: (data) => {
      const chosenIndex = data.response; // 0 = 첫 번째 이름, 1 = 두 번째 이름
      const nameA = jsPsych.evaluateTimelineVariable('nameA');
      const nameB = jsPsych.evaluateTimelineVariable('nameB');
      
      const chosenName = chosenIndex === 0 ? nameA : nameB;
      const otherName = chosenIndex === 0 ? nameB : nameA;

      data.task            = '2afc';
      data.target_type     = jsPsych.evaluateTimelineVariable('target_type');
      data.audio_file      = jsPsych.evaluateTimelineVariable('audio_path');
      data.nameA           = nameA;
      data.nameB           = nameB;
      data.trial_id        = jsPsych.evaluateTimelineVariable('id');
      data.chosen_version  = jsPsych.evaluateTimelineVariable('chosen_version');
      data.choice_order    = ['첫 번째 이름', '두 번째 이름']; // 고정 순서
      data.chosen_name     = chosenName;
      data.trial_start_time= currentTrialStartTime;
      data.response_time   = new Date().toISOString();
      data.user_agent      = navigator.userAgent;
    }
  };

  /* ===== DEMOGRAPHICS ===== */
    const demographics = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<h3>참가자 정보</h3><p>아래 정보를 입력해주세요.</p>',
      html: `
        <div style="text-align: left; max-width: 500px; margin: 0 auto;">
          <p><label for="gender"><strong>성별(선택):</strong></label><br>
          <input type="radio" name="gender" value="남" required> 남
          <input type="radio" name="gender" value="여" required> 여</p>
          
          <p><label for="birth_year"><strong>태어난 해:</strong></label><br>
          <input type="text" id="birth_year" name="birth_year" placeholder="YYYY (예: 1995)" pattern="[0-9]{4}" required style="width: 150px;"></p>
          
          <p><label for="birth_month"><strong>태어난 월:</strong></label><br>
          <input type="text" id="birth_month" name="birth_month" placeholder="MM (예: 03)" pattern="[0-9]{2}" required style="width: 80px;"></p>
          
          <p><label for="native_lang"><strong>모국어:</strong></label><br>
          <input type="text" id="native_lang" name="native_lang" placeholder="예: 한국어" required style="width: 200px;"></p>
          
          <p><label for="foreign_lang"><strong>영어 수준:</strong></label><br>
          <label><input type="radio" name="foreign_lang" value="낮음" required> 낮음</label>
          <label><input type="radio" name="foreign_lang" value="보통" required> 보통</label>
          <label><input type="radio" name="foreign_lang" value="높음" required> 높음</label></p>

          <p><strong>포켓몬 친숙도(선택):</strong><br>
          <label><input type="radio" name="pkmn_familiarity" value="낮음" required> 낮음</label>
          <label><input type="radio" name="pkmn_familiarity" value="보통" required> 보통</label>
          <label><input type="radio" name="pkmn_familiarity" value="높음" required> 높음</label></p>
        </div>
      `,
      button_label: '제출',
      data: { task: 'demographics' },
      on_finish: (data) => {
        data.user_agent = navigator.userAgent;
        data.timestamp = new Date().toISOString();
        console.log('Demographics:', data.response);
      }
    };
  /* ===== END ===== */
  const end = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `<h2>${TEXTS.endTitle}</h2><p>${TEXTS.endBody}</p>`,
    choices: [TEXTS.finishBtn]
  };

  /* ===== BLOCK & RUN ===== */
  const trials_block = {
    timeline: [twoAFC_trial],
    timeline_variables: STIMULI,
    randomize_order: true
  };

  jsPsych.run([preload, welcome, trials_block, demographics, end]);

  /* ===== GOOGLE SHEETS UPLOAD ===== */
  async function uploadAllRowsToGoogle() {
    console.log('=== 업로드 시작 ===');
    console.log('GAS_ENDPOINT:', GAS_ENDPOINT);
    
    if (!GAS_ENDPOINT || GAS_ENDPOINT.startsWith('PASTE_')) {
      console.warn('No GAS endpoint configured.');
      return false;
    }
    try {
      const all = jsPsych.data.get().values();
      console.log('전체 데이터 개수:', all.length);
      
      const demo = all.find(d => d.task === 'demographics');
      console.log('Demographics 찾음:', demo ? 'Yes' : 'No');
      const dmo  = demo?.response || {};
      console.log('Demographics 내용:', dmo);

      const rows = all
        .filter(d => d.task === '2afc')
        .map(d => {
          const { rt, ...rest } = d; // rt 제거
          return {
            trial_index:      rest.trial_index,
            task:             rest.task,
            trial_id:         rest.trial_id || '',
            chosen_version:   rest.chosen_version || '',
            target_type:      rest.target_type,
            audio_file:       rest.audio_file,
            nameA:            rest.nameA,
            nameB:            rest.nameB,
            choice_order:     JSON.stringify(rest.choice_order || []),
            chosen_name:      rest.chosen_name || '',
            time_elapsed:     rest.time_elapsed,
            trial_start_time: rest.trial_start_time || '',
            response_time:    rest.response_time || '',
            user_agent:       rest.user_agent || navigator.userAgent,
            gender:           dmo.gender || '',
            birth_year:       dmo.birth_year || '',
            birth_month:      dmo.birth_month || '',
            native_lang:      dmo.native_lang || '',
            foreign_lang:     dmo.foreign_lang || '',
            pkmn_familiarity: dmo.pkmn_familiarity || ''
          };
        });

      console.log('2afc 데이터 개수:', rows.length);
      console.log('첫 번째 row:', rows[0]);
      
      const payload = { data: rows };
      console.log('전송할 payload:', payload);
      console.log('Payload JSON 길이:', JSON.stringify(payload).length);

      console.log('fetch 시작...');
      
      // no-cors 모드로 전송 (CORS 에러 회피)
      const response = await fetch(GAS_ENDPOINT, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      console.log('fetch 완료');
      console.log('Response type:', response.type);
      console.log('Response status:', response.status);
      console.log('Upload attempted. Check your Google Sheet NOW!');
      
      // 5초 후에 다시 확인 메시지
      setTimeout(() => {
        console.log('5초 경과 - Google Sheets 확인하세요!');
      }, 5000);
      
      return true;
    } catch (e) {
      console.error('=== 업로드 에러 ===');
      console.error('Error:', e);
      console.error('Error message:', e.message);
      console.error('Error stack:', e.stack);
      return false;
    }
  }
</script>
</body>
</html>
